---
import AdminLayout from '../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestion des adhésions - Asso Info Evry">
  <!-- Admin Hero Header -->
  <section class="page-hero">
    <div class="page-hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-indigo"></div>
    </div>
    <div class="page-hero-content container">
      <h1 class="page-hero-title">
        <span>Gestion des</span>
        <span class="gradient-text">Adhésions</span>
      </h1>
      <p class="page-hero-subtitle">Administration des membres de l'association</p>
    </div>
  </section>

  <main class="container-wide admin">
    <!-- Auth Section -->
    <section id="auth-section" class="section glass-card">
      <h2>Authentification</h2>
      <div class="form-group">
        <label for="admin-token">Token d'administration</label>
        <input type="password" id="admin-token" placeholder="Entrez votre token...">
      </div>
      <button type="button" id="auth-btn" class="btn btn-primary">Connexion</button>
      <p id="auth-error" class="error-text hidden"></p>
    </section>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden">
      <!-- Stats Section -->
      <div class="disclosure-group open" data-disclosure="stats">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('stats')">
          <h2><span class="disclosure-chevron">􀆊</span> Vue d'ensemble</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="export-btn" class="btn btn-secondary btn-sm">Exporter CSV</button>
            <button type="button" id="refresh-btn" class="btn btn-secondary btn-sm">Rafraîchir</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="stats-grid" class="stats-grid"></div>
        </div>
      </div>

      <!-- Bureau Section -->
      <div class="disclosure-group open" data-disclosure="bureau">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('bureau')">
          <h2><span class="disclosure-chevron">􀆊</span> Bureau</h2>
        </div>
        <div class="disclosure-body">
          <div id="bureau-container"></div>
        </div>
      </div>

      <!-- Pending Applications -->
      <div class="disclosure-group open" data-disclosure="pending">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('pending')">
          <h2><span class="disclosure-chevron">􀆊</span> Demandes en attente <span id="pending-badge" class="disclosure-badge">0</span></h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="approve-all-btn" class="btn btn-primary btn-sm" disabled>Tout approuver</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="pending-container" class="table-container"></div>
        </div>
      </div>

      <!-- All Members -->
      <div class="disclosure-group open" data-disclosure="members">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('members')">
          <h2><span class="disclosure-chevron">􀆊</span> Tous les membres <span id="members-badge" class="disclosure-badge">0</span></h2>
        </div>
        <div class="disclosure-body">
          <div class="members-toolbar">
            <div class="filters-row">
              <input type="search" id="filter-search" class="filter-search" placeholder="Rechercher (nom, email, n° étudiant...)">
              <select id="filter-status" class="filter-select">
                <option value="">Tous les statuts</option>
                <option value="active">Membres actifs</option>
                <option value="honor">Membres d'honneur</option>
                <option value="honorary_president">Présidents d'honneur</option>
                <option value="bureau">Bureau</option>
                <option value="pending">En attente</option>
                <option value="rejected">Refusés</option>
                <option value="expired">Expirés</option>
              </select>
              <select id="filter-track" class="filter-select">
                <option value="">Tous les cursus</option>
              </select>
            </div>
            <div id="bulk-actions" class="bulk-actions hidden">
              <span id="selection-count">0 sélectionné(s)</span>
              <button type="button" class="btn btn-sm btn-primary" onclick="window.adminDashboard.bulkApprove()">Approuver</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="window.adminDashboard.bulkSetStatus('active')">→ Actif</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="window.adminDashboard.bulkSetStatus('honor')">→ Honneur</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="window.adminDashboard.bulkSetStatus('expired')">→ Expiré</button>
              <button type="button" class="btn btn-sm btn-danger" onclick="window.adminDashboard.bulkDelete()">Supprimer</button>
            </div>
          </div>
          <div id="members-container" class="table-container"></div>
        </div>
      </div>

      <!-- Import Section -->
      <div class="disclosure-group" data-disclosure="import">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('import')">
          <h2><span class="disclosure-chevron">􀆊</span> Importer des membres</h2>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Import CSV</h3>
            <p style="margin-bottom: var(--space-3); color: var(--color-text-muted);">
              Format attendu: Prénom, Nom, Email, Téléphone, Numéro, Filière d'inscription, Statut
            </p>
            <div class="form-group">
              <label for="import-file">Fichier CSV</label>
              <input type="file" id="import-file" accept=".csv,.txt">
            </div>
            <div id="import-preview" class="hidden" style="margin: var(--space-4) 0;">
              <h4>Aperçu</h4>
              <div id="import-preview-content"></div>
            </div>
            <div class="quick-actions">
              <button type="button" id="import-btn" class="btn btn-primary btn-sm" disabled>Importer</button>
            </div>
            <div id="import-result" class="hidden" style="margin-top: var(--space-4);"></div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="disclosure-group" data-disclosure="settings">
        <div class="disclosure-header" onclick="window.adminDashboard.toggleDisclosure('settings')">
          <h2><span class="disclosure-chevron">􀆊</span> Paramètres</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="save-settings-btn" class="btn btn-primary btn-sm" disabled>Enregistrer</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Inscriptions</h3>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="setting-membership-open" checked>
                Accepter les nouvelles demandes d'adhésion
              </label>
            </div>
            <div class="form-group">
              <label for="setting-current-year">Année universitaire</label>
              <input type="text" id="setting-current-year" value="2024-2025" placeholder="2024-2025">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="member-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="member-modal-title">Modifier le membre</h3>
        <form id="member-form">
          <input type="hidden" id="member-form-id">
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-firstname">Prénom *</label>
              <input type="text" id="member-form-firstname" required>
            </div>
            <div class="form-group">
              <label for="member-form-lastname">Nom *</label>
              <input type="text" id="member-form-lastname" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-email">Email *</label>
              <input type="email" id="member-form-email" required>
            </div>
            <div class="form-group">
              <label for="member-form-studentid">Numéro étudiant</label>
              <input type="text" id="member-form-studentid" maxlength="32" placeholder="Optionnel">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-track">Cursus</label>
              <input type="text" id="member-form-track" list="admin-cursus-list" placeholder="Ex: L3 Informatique">
              <datalist id="admin-cursus-list">
                <option value="L1 Informatique">
                <option value="L2 Informatique">
                <option value="L3 Informatique">
                <option value="M1 Informatique">
                <option value="M2 Informatique">
                <option value="Doctorat Informatique">
                <option value="L1 Mathématiques">
                <option value="L2 Mathématiques">
                <option value="L3 Mathématiques">
                <option value="Autre">
              </datalist>
            </div>
            <div class="form-group">
              <label for="member-form-status">Statut</label>
              <select id="member-form-status">
                <option value="pending">En attente</option>
                <option value="active">Membre actif</option>
                <option value="honor">Membre d'honneur</option>
                <option value="president">Président</option>
                <option value="vice_president">Vice-président</option>
                <option value="secretary">Secrétaire</option>
                <option value="treasurer">Trésorier</option>
                <option value="honorary_president">Président d'honneur</option>
                <option value="rejected">Refusé</option>
                <option value="expired">Expiré</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="member-form-notes">Notes</label>
            <textarea id="member-form-notes" rows="2"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="window.adminDashboard.closeModal('member-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Confirmer l'action</h3>
        <p id="confirm-message"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="window.adminDashboard.closeModal('confirm-modal')">Annuler</button>
          <button type="button" id="confirm-btn" class="btn btn-danger">Confirmer</button>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>

<meta name="base-url" content={import.meta.env.BASE_URL} />

<script type="module">
import * as adminDashboard from '../client/admin-dashboard.js';

// Export to window for onclick handlers
window.adminDashboard = adminDashboard;

// Initialize dashboard when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => adminDashboard.initAdminDashboard());
} else {
  adminDashboard.initAdminDashboard();
}
</script>

<style>
/* Members toolbar and filters */
.members-toolbar {
  margin-bottom: var(--space-4);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.filters-row {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  align-items: center;
}

.filter-search {
  flex: 1;
  min-width: 200px;
  max-width: 400px;
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--border-default);
  border-radius: var(--radius);
  font: inherit;
  font-size: var(--text-sm);
  background-color: var(--color-surface);
  color: var(--color-text);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.filter-search:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(0, 27, 165, 0.2);
}

.filter-search::placeholder {
  color: var(--color-text-muted);
}

/* Bulk actions bar */
.bulk-actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3);
  background: rgba(0, 27, 165, 0.1);
  border: 1px solid var(--color-primary);
  border-radius: var(--radius);
  flex-wrap: wrap;
}

.bulk-actions span {
  font-weight: 600;
  color: var(--color-primary);
  margin-right: var(--space-2);
}

/* Wide table for more columns */
.table-container {
  overflow-x: auto;
}

.members-table-wide {
  min-width: 1000px;
}

.members-table-wide th,
.members-table-wide td {
  white-space: nowrap;
}

.members-table-wide td:nth-child(2) {
  white-space: normal;
  max-width: 200px;
}

/* Contact cell */
.contact-cell {
  font-size: var(--text-xs);
  line-height: 1.4;
}

/* Action buttons in table */
.action-buttons {
  display: flex;
  gap: var(--space-1);
}

/* Selected row */
tr.selected td {
  background: rgba(0, 27, 165, 0.1) !important;
}

/* Text muted helper */
.text-muted {
  color: var(--color-text-muted);
}

small.text-muted {
  font-size: var(--text-xs);
}

/* Sortable headers */
.sortable {
  cursor: pointer;
  user-select: none;
  transition: background-color var(--transition-fast);
}

.sortable:hover {
  background-color: rgba(0, 27, 165, 0.1);
}

@media (max-width: 768px) {
  .filters-row {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-search {
    max-width: none;
  }

  .bulk-actions {
    flex-direction: column;
    align-items: flex-start;
  }
}
</style>
