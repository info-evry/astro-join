---
import AdminLayout from '../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestion des adhésions - Asso Info Evry">
  <!-- Admin Hero Header -->
  <section class="page-hero">
    <div class="page-hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-indigo"></div>
    </div>
    <div class="page-hero-content container">
      <h1 class="page-hero-title">
        <span>Gestion des</span>
        <span class="gradient-text">Adhésions</span>
      </h1>
      <p class="page-hero-subtitle">Administration des membres de l'association</p>
    </div>
  </section>

  <main class="container admin">
    <!-- Auth Section -->
    <section id="auth-section" class="section glass-card">
      <h2>Authentification</h2>
      <div class="form-group">
        <label for="admin-token">Token d'administration</label>
        <input type="password" id="admin-token" placeholder="Entrez votre token...">
      </div>
      <button type="button" id="auth-btn" class="btn btn-primary">Connexion</button>
      <p id="auth-error" class="error-text hidden"></p>
    </section>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden">
      <!-- Stats Section -->
      <div class="disclosure-group open" data-disclosure="stats">
        <div class="disclosure-header" onclick="toggleDisclosure('stats')">
          <h2><span class="disclosure-chevron">􀆊</span> Vue d'ensemble</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="export-btn" class="btn btn-secondary btn-sm">Exporter CSV</button>
            <button type="button" id="refresh-btn" class="btn btn-secondary btn-sm">Rafraîchir</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="stats-grid" class="stats-grid"></div>
        </div>
      </div>

      <!-- Bureau Section -->
      <div class="disclosure-group open" data-disclosure="bureau">
        <div class="disclosure-header" onclick="toggleDisclosure('bureau')">
          <h2><span class="disclosure-chevron">􀆊</span> Bureau</h2>
        </div>
        <div class="disclosure-body">
          <div id="bureau-container"></div>
        </div>
      </div>

      <!-- Pending Applications -->
      <div class="disclosure-group open" data-disclosure="pending">
        <div class="disclosure-header" onclick="toggleDisclosure('pending')">
          <h2><span class="disclosure-chevron">􀆊</span> Demandes en attente <span id="pending-badge" class="disclosure-badge">0</span></h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="approve-all-btn" class="btn btn-primary btn-sm" disabled>Tout approuver</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="pending-container"></div>
        </div>
      </div>

      <!-- All Members -->
      <div class="disclosure-group open" data-disclosure="members">
        <div class="disclosure-header" onclick="toggleDisclosure('members')">
          <h2><span class="disclosure-chevron">􀆊</span> Tous les membres <span id="members-badge" class="disclosure-badge">0</span></h2>
        </div>
        <div class="disclosure-body">
          <div class="members-toolbar">
            <div class="filters-row">
              <input type="search" id="filter-search" class="filter-search" placeholder="Rechercher (nom, email, n° étudiant...)">
              <select id="filter-status" class="filter-select">
                <option value="">Tous les statuts</option>
                <option value="active">Membres actifs</option>
                <option value="honor">Membres d'honneur</option>
                <option value="honorary_president">Présidents d'honneur</option>
                <option value="bureau">Bureau</option>
                <option value="pending">En attente</option>
                <option value="rejected">Refusés</option>
                <option value="expired">Expirés</option>
              </select>
              <select id="filter-track" class="filter-select">
                <option value="">Tous les cursus</option>
              </select>
            </div>
            <div id="bulk-actions" class="bulk-actions hidden">
              <span id="selection-count">0 sélectionné(s)</span>
              <button type="button" class="btn btn-sm btn-primary" onclick="bulkApprove()">Approuver</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="bulkSetStatus('active')">→ Actif</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="bulkSetStatus('honor')">→ Honneur</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="bulkSetStatus('expired')">→ Expiré</button>
              <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()">Supprimer</button>
            </div>
          </div>
          <div id="members-container" class="table-container"></div>
        </div>
      </div>

      <!-- Import Section -->
      <div class="disclosure-group" data-disclosure="import">
        <div class="disclosure-header" onclick="toggleDisclosure('import')">
          <h2><span class="disclosure-chevron">􀆊</span> Importer des membres</h2>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Import CSV</h3>
            <p style="margin-bottom: var(--space-3); color: var(--color-text-muted);">
              Format attendu: Prénom, Nom, Email, Téléphone, Numéro, Filière d'inscription, Statut
            </p>
            <div class="form-group">
              <label for="import-file">Fichier CSV</label>
              <input type="file" id="import-file" accept=".csv,.txt">
            </div>
            <div id="import-preview" class="hidden" style="margin: var(--space-4) 0;">
              <h4>Aperçu</h4>
              <div id="import-preview-content"></div>
            </div>
            <div class="quick-actions">
              <button type="button" id="import-btn" class="btn btn-primary" disabled>Importer</button>
            </div>
            <div id="import-result" class="hidden" style="margin-top: var(--space-4);"></div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="disclosure-group" data-disclosure="settings">
        <div class="disclosure-header" onclick="toggleDisclosure('settings')">
          <h2><span class="disclosure-chevron">􀆊</span> Paramètres</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="save-settings-btn" class="btn btn-primary btn-sm" disabled>Enregistrer</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Inscriptions</h3>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="setting-membership-open" checked>
                Accepter les nouvelles demandes d'adhésion
              </label>
            </div>
            <div class="form-group">
              <label for="setting-current-year">Année universitaire</label>
              <input type="text" id="setting-current-year" value="2024-2025" placeholder="2024-2025">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="member-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="member-modal-title">Modifier le membre</h3>
        <form id="member-form">
          <input type="hidden" id="member-form-id">
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-firstname">Prénom *</label>
              <input type="text" id="member-form-firstname" required>
            </div>
            <div class="form-group">
              <label for="member-form-lastname">Nom *</label>
              <input type="text" id="member-form-lastname" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-email">Email *</label>
              <input type="email" id="member-form-email" required>
            </div>
            <div class="form-group">
              <label for="member-form-studentid">Numéro étudiant</label>
              <input type="text" id="member-form-studentid" maxlength="32" placeholder="Optionnel">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-track">Cursus</label>
              <input type="text" id="member-form-track" list="admin-cursus-list" placeholder="Ex: L3 Informatique">
              <datalist id="admin-cursus-list">
                <option value="L1 Informatique">
                <option value="L2 Informatique">
                <option value="L3 Informatique">
                <option value="M1 Informatique">
                <option value="M2 Informatique">
                <option value="Doctorat Informatique">
                <option value="L1 Mathématiques">
                <option value="L2 Mathématiques">
                <option value="L3 Mathématiques">
                <option value="Autre">
              </datalist>
            </div>
            <div class="form-group">
              <label for="member-form-status">Statut</label>
              <select id="member-form-status">
                <option value="pending">En attente</option>
                <option value="active">Membre actif</option>
                <option value="honor">Membre d'honneur</option>
                <option value="president">Président</option>
                <option value="vice_president">Vice-président</option>
                <option value="secretary">Secrétaire</option>
                <option value="treasurer">Trésorier</option>
                <option value="honorary_president">Président d'honneur</option>
                <option value="rejected">Refusé</option>
                <option value="expired">Expiré</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="member-form-notes">Notes</label>
            <textarea id="member-form-notes" rows="2"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('member-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Confirmer l'action</h3>
        <p id="confirm-message"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-modal')">Annuler</button>
          <button type="button" id="confirm-btn" class="btn btn-danger">Confirmer</button>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>

<script define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
/**
 * Membership Admin Dashboard
 */

// API base URL (from Astro's BASE_URL)
const API_BASE = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function $(id) {
  return document.getElementById(id);
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function debounce(fn, delay) {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn(...args), delay);
  };
}

function sortMembers(members) {
  return [...members].sort((a, b) => {
    let valA = a[sortField];
    let valB = b[sortField];

    // Handle null/undefined
    if (valA == null) valA = '';
    if (valB == null) valB = '';

    // String comparison
    if (typeof valA === 'string') valA = valA.toLowerCase();
    if (typeof valB === 'string') valB = valB.toLowerCase();

    let comparison = 0;
    if (valA < valB) comparison = -1;
    else if (valA > valB) comparison = 1;

    return sortDirection === 'asc' ? comparison : -comparison;
  });
}

window.toggleSort = function(field) {
  if (sortField === field) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDirection = 'asc';
  }
  renderMembers(membersData);
};

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(message, type = 'success', duration = 3000) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function toastSuccess(message) { showToast(message, 'success'); }
function toastError(message) { showToast(message, 'error'); }

// ============================================================
// API FUNCTIONS
// ============================================================

let adminToken = localStorage.getItem('join_admin_token') || '';

async function api(endpoint, options = {}) {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: {
      'Authorization': `Bearer ${adminToken}`,
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  });

  if (response.status === 401) {
    throw new Error('Unauthorized');
  }

  if (response.headers.get('Content-Type')?.includes('text/csv')) {
    return response;
  }

  if (!response.ok) {
    const data = await response.json();
    throw new Error(data.error || 'Request failed');
  }

  return response.json();
}

// ============================================================
// STATE
// ============================================================

let membersData = [];
let statsData = null;

// ============================================================
// DOM ELEMENTS
// ============================================================

const elements = {
  authSection: $('auth-section'),
  adminContent: $('admin-content'),
  tokenInput: $('admin-token'),
  authBtn: $('auth-btn'),
  authError: $('auth-error'),
  statsGrid: $('stats-grid'),
  bureauContainer: $('bureau-container'),
  pendingContainer: $('pending-container'),
  pendingBadge: $('pending-badge'),
  membersContainer: $('members-container'),
  membersBadge: $('members-badge'),
  filterSearch: $('filter-search'),
  filterStatus: $('filter-status'),
  filterTrack: $('filter-track'),
  bulkActions: $('bulk-actions'),
  selectionCount: $('selection-count'),
  exportBtn: $('export-btn'),
  refreshBtn: $('refresh-btn'),
  approveAllBtn: $('approve-all-btn'),
  memberModal: $('member-modal'),
  memberForm: $('member-form'),
  confirmModal: $('confirm-modal'),
  confirmBtn: $('confirm-btn'),
  saveSettingsBtn: $('save-settings-btn'),
  importFile: $('import-file'),
  importBtn: $('import-btn'),
  importPreview: $('import-preview'),
  importPreviewContent: $('import-preview-content'),
  importResult: $('import-result')
};

// Selection state
let selectedMembers = new Set();

// Sort state
let sortField = 'created_at';
let sortDirection = 'desc';

// Status labels for display
const STATUS_LABELS = {
  pending: 'En attente',
  active: 'Membre actif',
  honor: "Membre d'honneur",
  secretary: 'Secrétaire',
  treasurer: 'Trésorier',
  president: 'Président',
  honorary_president: "Président d'honneur",
  vice_president: 'Vice-président',
  rejected: 'Refusé',
  expired: 'Expiré'
};

const BUREAU_STATUSES = ['secretary', 'treasurer', 'president', 'honorary_president', 'vice_president'];

// ============================================================
// MODAL & DISCLOSURE
// ============================================================

window.closeModal = function(modalId) {
  $(modalId).classList.add('hidden');
};

function openModal(modalId) {
  $(modalId).classList.remove('hidden');
}

window.toggleDisclosure = function(name) {
  const group = document.querySelector(`[data-disclosure="${name}"]`);
  if (group) group.classList.toggle('open');
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

function renderStats(stats) {
  elements.statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.active}</div>
      <div class="stat-label">Membres actifs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.pending}</div>
      <div class="stat-label">En attente</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.expired}</div>
      <div class="stat-label">Expirés</div>
    </div>
  `;
}

function renderBureau(members) {
  const bureau = members.filter(m => BUREAU_STATUSES.includes(m.status));

  if (bureau.length === 0) {
    elements.bureauContainer.innerHTML = '<p class="text-muted">Aucun membre du bureau défini</p>';
    return;
  }

  // Sort by role importance
  const roleOrder = ['president', 'vice_president', 'secretary', 'treasurer', 'honorary_president'];
  bureau.sort((a, b) => roleOrder.indexOf(a.status) - roleOrder.indexOf(b.status));

  elements.bureauContainer.innerHTML = `
    <div class="bureau-grid">
      ${bureau.map(m => `
        <div class="bureau-card">
          <div class="bureau-role">${STATUS_LABELS[m.status] || m.status}</div>
          <div class="bureau-name">${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</div>
          <div class="bureau-email"><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></div>
          <button class="btn btn-sm btn-secondary" onclick="editMember(${m.id})">Modifier</button>
        </div>
      `).join('')}
    </div>
  `;
}

function renderPendingApplications(members) {
  const pending = members.filter(m => m.status === 'pending');
  elements.pendingBadge.textContent = pending.length;
  elements.approveAllBtn.disabled = pending.length === 0;

  if (pending.length === 0) {
    elements.pendingContainer.innerHTML = '<p class="text-muted">Aucune demande en attente</p>';
    return;
  }

  elements.pendingContainer.innerHTML = `
    <table class="data-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>Cursus</th>
          <th>Contact</th>
          <th>Date</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${pending.map(m => `
          <tr data-id="${m.id}">
            <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
            <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
            <td>${escapeHtml(m.enrollment_track)}</td>
            <td>${getContactInfo(m)}</td>
            <td>${formatDate(m.created_at, true)}</td>
            <td class="actions-col">
              <button class="btn btn-sm btn-primary" onclick="approveMember(${m.id})">Approuver</button>
              <button class="btn btn-sm btn-danger" onclick="rejectMember(${m.id})">Refuser</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function renderMembers(members) {
  const statusFilter = elements.filterStatus.value;
  const trackFilter = elements.filterTrack.value;
  const searchQuery = (elements.filterSearch.value || '').toLowerCase().trim();

  let filtered = members;

  // Status filter
  if (statusFilter) {
    if (statusFilter === 'bureau') {
      filtered = filtered.filter(m => BUREAU_STATUSES.includes(m.status));
    } else {
      filtered = filtered.filter(m => m.status === statusFilter);
    }
  }

  // Track filter
  if (trackFilter) filtered = filtered.filter(m => m.enrollment_track === trackFilter);

  // Search filter
  if (searchQuery) {
    filtered = filtered.filter(m => {
      const searchFields = [
        m.first_name, m.last_name, m.email, m.student_id,
        m.phone, m.telegram, m.discord, m.enrollment_track, m.notes
      ].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(searchQuery);
    });
  }

  elements.membersBadge.textContent = filtered.length;

  // Update selection to only include visible members
  const visibleIds = new Set(filtered.map(m => m.id));
  selectedMembers = new Set([...selectedMembers].filter(id => visibleIds.has(id)));
  updateSelectionUI();

  if (filtered.length === 0) {
    elements.membersContainer.innerHTML = '<p class="text-muted">Aucun membre trouvé</p>';
    return;
  }

  // Apply sorting
  filtered = sortMembers(filtered);

  const allSelected = filtered.length > 0 && filtered.every(m => selectedMembers.has(m.id));

  const sortIcon = (field) => {
    if (sortField !== field) return '';
    return sortDirection === 'asc' ? ' ▲' : ' ▼';
  };

  elements.membersContainer.innerHTML = `
    <table class="data-table members-table-wide">
      <thead>
        <tr>
          <th class="checkbox-col">
            <input type="checkbox" id="select-all" ${allSelected ? 'checked' : ''} onchange="toggleSelectAll(this.checked)">
          </th>
          <th class="sortable" onclick="toggleSort('last_name')">Nom${sortIcon('last_name')}</th>
          <th class="sortable" onclick="toggleSort('email')">Email${sortIcon('email')}</th>
          <th class="sortable" onclick="toggleSort('student_id')">N° Étudiant${sortIcon('student_id')}</th>
          <th class="sortable" onclick="toggleSort('enrollment_track')">Cursus${sortIcon('enrollment_track')}</th>
          <th>Contact</th>
          <th class="sortable" onclick="toggleSort('status')">Statut${sortIcon('status')}</th>
          <th class="sortable" onclick="toggleSort('created_at')">Inscription${sortIcon('created_at')}</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(m => `
          <tr data-id="${m.id}" class="${selectedMembers.has(m.id) ? 'selected' : ''}">
            <td class="checkbox-col">
              <input type="checkbox" ${selectedMembers.has(m.id) ? 'checked' : ''} onchange="toggleMemberSelection(${m.id}, this.checked)">
            </td>
            <td>
              <strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong>
              ${m.notes ? `<br><small class="text-muted">${escapeHtml(m.notes.substring(0, 50))}${m.notes.length > 50 ? '...' : ''}</small>` : ''}
            </td>
            <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
            <td>${m.student_id ? escapeHtml(m.student_id) : '<span class="text-muted">-</span>'}</td>
            <td>${escapeHtml(m.enrollment_track)}</td>
            <td class="contact-cell">${getContactInfo(m)}</td>
            <td><span class="badge badge-${getStatusClass(m.status)}">${getStatusLabel(m.status)}</span></td>
            <td>${formatDate(m.created_at, true)}</td>
            <td class="actions-col">
              <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" onclick="editMember(${m.id})" title="Modifier">✏️</button>
                ${m.status === 'pending' ? `<button class="btn btn-sm btn-primary" onclick="approveMember(${m.id})" title="Approuver">✓</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="confirmDeleteMember(${m.id})" title="Supprimer">×</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function updateSelectionUI() {
  const count = selectedMembers.size;
  elements.selectionCount.textContent = `${count} sélectionné(s)`;

  if (count > 0) {
    elements.bulkActions.classList.remove('hidden');
  } else {
    elements.bulkActions.classList.add('hidden');
  }
}

window.toggleSelectAll = function(checked) {
  const statusFilter = elements.filterStatus.value;
  const trackFilter = elements.filterTrack.value;
  const searchQuery = (elements.filterSearch.value || '').toLowerCase().trim();

  let filtered = membersData;
  if (statusFilter) {
    if (statusFilter === 'bureau') {
      filtered = filtered.filter(m => BUREAU_STATUSES.includes(m.status));
    } else {
      filtered = filtered.filter(m => m.status === statusFilter);
    }
  }
  if (trackFilter) filtered = filtered.filter(m => m.enrollment_track === trackFilter);
  if (searchQuery) {
    filtered = filtered.filter(m => {
      const searchFields = [m.first_name, m.last_name, m.email, m.student_id, m.phone, m.telegram, m.discord, m.enrollment_track, m.notes].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(searchQuery);
    });
  }

  if (checked) {
    filtered.forEach(m => selectedMembers.add(m.id));
  } else {
    selectedMembers.clear();
  }
  renderMembers(membersData);
};

window.toggleMemberSelection = function(id, checked) {
  if (checked) {
    selectedMembers.add(id);
  } else {
    selectedMembers.delete(id);
  }
  updateSelectionUI();

  // Update row styling
  const row = document.querySelector(`tr[data-id="${id}"]`);
  if (row) {
    row.classList.toggle('selected', checked);
  }

  // Update select-all checkbox
  const selectAll = $('select-all');
  if (selectAll) {
    const visibleRows = document.querySelectorAll('#members-container tbody tr');
    const allChecked = [...visibleRows].every(row => selectedMembers.has(parseInt(row.dataset.id)));
    selectAll.checked = allChecked && visibleRows.length > 0;
  }
};

function getContactInfo(m) {
  const contacts = [];
  if (m.phone) contacts.push(`Tel: ${escapeHtml(m.phone)}`);
  if (m.telegram) contacts.push(`TG: ${escapeHtml(m.telegram)}`);
  if (m.discord) contacts.push(`DC: ${escapeHtml(m.discord)}`);
  return contacts.length > 0 ? contacts.join('<br>') : '-';
}

function getStatusClass(status) {
  const classes = {
    'active': 'success',
    'pending': 'warning',
    'rejected': 'error',
    'expired': 'secondary'
  };
  return classes[status] || 'secondary';
}

function getStatusLabel(status) {
  const labels = {
    'active': 'Actif',
    'pending': 'En attente',
    'rejected': 'Refusé',
    'expired': 'Expiré'
  };
  return labels[status] || status;
}

function formatDate(dateStr, includeTime = false) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  if (includeTime) {
    return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }
  return date.toLocaleDateString('fr-FR');
}

function populateTrackFilter(members) {
  const tracks = [...new Set(members.map(m => m.enrollment_track))].sort();
  elements.filterTrack.innerHTML = '<option value="">Tous les cursus</option>' +
    tracks.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
}

// ============================================================
// MEMBER ACTIONS
// ============================================================

window.approveMember = async function(id) {
  try {
    await api(`/admin/members/${id}`, {
      method: 'PUT',
      body: JSON.stringify({ status: 'active', reason: 'Approved by admin' })
    });
    toastSuccess('Membre approuvé');
    loadData();
  } catch (err) {
    toastError(err.message);
  }
};

window.rejectMember = async function(id) {
  $('confirm-message').textContent = 'Êtes-vous sûr de vouloir refuser cette demande ?';
  elements.confirmBtn.onclick = async () => {
    try {
      await api(`/admin/members/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ status: 'rejected', reason: 'Rejected by admin' })
      });
      toastSuccess('Demande refusée');
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
};

window.editMember = function(id) {
  const member = membersData.find(m => m.id === id);
  if (!member) return;

  $('member-modal-title').textContent = 'Modifier le membre';
  $('member-form-id').value = id;
  $('member-form-firstname').value = member.first_name;
  $('member-form-lastname').value = member.last_name;
  $('member-form-email').value = member.email;
  $('member-form-studentid').value = member.student_id || '';
  $('member-form-track').value = member.enrollment_track;
  $('member-form-status').value = member.status;
  $('member-form-notes').value = member.notes || '';
  openModal('member-modal');
};

window.confirmDeleteMember = function(id) {
  const member = membersData.find(m => m.id === id);
  $('confirm-message').textContent = `Êtes-vous sûr de vouloir supprimer ${member?.first_name} ${member?.last_name} ?`;
  elements.confirmBtn.onclick = async () => {
    try {
      await api(`/admin/members/${id}`, { method: 'DELETE' });
      toastSuccess('Membre supprimé');
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
};

async function handleMemberSubmit(e) {
  e.preventDefault();
  const id = $('member-form-id').value;

  try {
    await api(`/admin/members/${id}`, {
      method: 'PUT',
      body: JSON.stringify({
        firstName: $('member-form-firstname').value,
        lastName: $('member-form-lastname').value,
        email: $('member-form-email').value,
        studentId: $('member-form-studentid').value,
        enrollmentTrack: $('member-form-track').value,
        status: $('member-form-status').value,
        notes: $('member-form-notes').value
      })
    });
    toastSuccess('Membre mis à jour');
    closeModal('member-modal');
    loadData();
  } catch (err) {
    toastError(err.message);
  }
}

async function approveAll() {
  const pending = membersData.filter(m => m.status === 'pending');
  if (pending.length === 0) return;

  $('confirm-message').textContent = `Approuver ${pending.length} demande(s) ?`;
  elements.confirmBtn.className = 'btn btn-primary';
  elements.confirmBtn.textContent = 'Approuver';
  elements.confirmBtn.onclick = async () => {
    try {
      await api('/admin/members/batch', {
        method: 'POST',
        body: JSON.stringify({
          memberIds: pending.map(m => m.id),
          status: 'active',
          reason: 'Batch approved by admin'
        })
      });
      toastSuccess(`${pending.length} membre(s) approuvé(s)`);
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
}

// ============================================================
// BULK ACTIONS
// ============================================================

window.bulkApprove = async function() {
  if (selectedMembers.size === 0) return;

  const ids = [...selectedMembers];
  $('confirm-message').textContent = `Approuver ${ids.length} membre(s) sélectionné(s) ?`;
  elements.confirmBtn.className = 'btn btn-primary';
  elements.confirmBtn.textContent = 'Approuver';
  elements.confirmBtn.onclick = async () => {
    try {
      await api('/admin/members/batch', {
        method: 'POST',
        body: JSON.stringify({
          memberIds: ids,
          status: 'active',
          reason: 'Bulk approved by admin'
        })
      });
      toastSuccess(`${ids.length} membre(s) approuvé(s)`);
      selectedMembers.clear();
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
};

window.bulkSetStatus = async function(newStatus) {
  if (selectedMembers.size === 0) return;

  const ids = [...selectedMembers];
  const statusLabel = STATUS_LABELS[newStatus] || newStatus;

  $('confirm-message').textContent = `Définir ${ids.length} membre(s) comme "${statusLabel}" ?`;
  elements.confirmBtn.className = 'btn btn-primary';
  elements.confirmBtn.textContent = 'Confirmer';
  elements.confirmBtn.onclick = async () => {
    try {
      await api('/admin/members/batch', {
        method: 'POST',
        body: JSON.stringify({
          memberIds: ids,
          status: newStatus,
          reason: `Bulk status change to ${newStatus} by admin`
        })
      });
      toastSuccess(`${ids.length} membre(s) mis à jour`);
      selectedMembers.clear();
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
};

window.bulkDelete = async function() {
  if (selectedMembers.size === 0) return;

  const ids = [...selectedMembers];
  $('confirm-message').innerHTML = `<strong style="color: var(--color-error);">Supprimer définitivement ${ids.length} membre(s) ?</strong><br><small>Cette action est irréversible.</small>`;
  elements.confirmBtn.className = 'btn btn-danger';
  elements.confirmBtn.textContent = 'Supprimer';
  elements.confirmBtn.onclick = async () => {
    try {
      // Delete one by one (no batch delete endpoint yet)
      let deleted = 0;
      for (const id of ids) {
        try {
          await api(`/admin/members/${id}`, { method: 'DELETE' });
          deleted++;
        } catch (e) {
          console.error(`Failed to delete member ${id}:`, e);
        }
      }
      toastSuccess(`${deleted} membre(s) supprimé(s)`);
      selectedMembers.clear();
      closeModal('confirm-modal');
      loadData();
    } catch (err) {
      toastError(err.message);
    }
  };
  openModal('confirm-modal');
};

// ============================================================
// DATA LOADING
// ============================================================

async function loadData() {
  try {
    const data = await api('/admin/members');
    membersData = data.members || [];
    statsData = data.stats;

    renderStats(statsData);
    renderBureau(membersData);
    renderPendingApplications(membersData);
    renderMembers(membersData);
    populateTrackFilter(membersData);
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuth();
      toastError('Session expirée');
    } else {
      toastError(err.message);
    }
  }
}

async function handleExport() {
  try {
    const status = elements.filterStatus.value;
    const url = status ? `/admin/export?status=${status}` : '/admin/export';
    const response = await api(url);
    const blob = await response.blob();
    const downloadUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = status ? `members_${status}.csv` : 'members.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(downloadUrl);
  } catch (err) {
    toastError(err.message);
  }
}

// ============================================================
// IMPORT CSV
// ============================================================

let importData = null;

function handleImportFileChange(event) {
  const file = event.target.files[0];
  if (!file) {
    elements.importBtn.disabled = true;
    elements.importPreview.classList.add('hidden');
    importData = null;
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    importData = e.target.result;

    // Show preview
    const lines = importData.trim().split('\n').slice(0, 6);
    const previewHtml = lines.map((line, i) => {
      const cells = line.split(/[,;\t]/).slice(0, 5);
      return `<tr class="${i === 0 ? 'header-row' : ''}">
        ${cells.map(c => `<td>${escapeHtml(c.replace(/^"|"$/g, '').trim())}</td>`).join('')}
        ${cells.length < 5 ? '<td>...</td>' : ''}
      </tr>`;
    }).join('');

    elements.importPreviewContent.innerHTML = `
      <table class="data-table" style="font-size: var(--text-xs);">
        <tbody>${previewHtml}</tbody>
      </table>
      <p style="color: var(--color-text-muted); margin-top: var(--space-2);">
        ${importData.trim().split('\n').length - 1} ligne(s) de données
      </p>
    `;
    elements.importPreview.classList.remove('hidden');
    elements.importBtn.disabled = false;
  };
  reader.readAsText(file);
}

async function handleImport() {
  if (!importData) return;

  elements.importBtn.disabled = true;
  elements.importBtn.textContent = 'Import en cours...';

  try {
    const result = await api('/admin/import', {
      method: 'POST',
      body: JSON.stringify({ csv: importData })
    });

    const stats = result.stats;
    let message = `Import terminé: ${stats.imported} ajouté(s), ${stats.updated} mis à jour`;
    if (stats.skipped > 0) message += `, ${stats.skipped} ignoré(s)`;

    elements.importResult.innerHTML = `
      <div class="toast success" style="position: static; transform: none;">
        ${message}
      </div>
      ${result.errors ? `
        <div style="margin-top: var(--space-2); color: var(--color-error); font-size: var(--text-sm);">
          <strong>Erreurs:</strong>
          <ul>${result.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul>
        </div>
      ` : ''}
    `;
    elements.importResult.classList.remove('hidden');

    toastSuccess(message);
    loadData();

    // Reset form
    elements.importFile.value = '';
    elements.importPreview.classList.add('hidden');
    importData = null;
  } catch (err) {
    toastError(err.message);
    elements.importResult.innerHTML = `
      <div class="toast error" style="position: static; transform: none;">
        Erreur: ${escapeHtml(err.message)}
      </div>
    `;
    elements.importResult.classList.remove('hidden');
  }

  elements.importBtn.disabled = true;
  elements.importBtn.textContent = 'Importer';
}

// ============================================================
// AUTH
// ============================================================

function showAuth() {
  elements.authSection.classList.remove('hidden');
  elements.adminContent.classList.add('hidden');
}

function showAdmin() {
  elements.authSection.classList.add('hidden');
  elements.adminContent.classList.remove('hidden');
}

function showAuthError(message) {
  elements.authError.textContent = message;
  elements.authError.classList.remove('hidden');
}

async function handleAuth() {
  const token = elements.tokenInput.value.trim();
  if (!token) {
    showAuthError('Token requis');
    return;
  }

  adminToken = token;
  elements.authError.classList.add('hidden');

  try {
    await loadData();
    localStorage.setItem('join_admin_token', token);
    showAdmin();
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuthError('Token invalide');
      adminToken = '';
      localStorage.removeItem('join_admin_token');
    } else {
      showAuthError(err.message);
    }
  }
}

// ============================================================
// SETTINGS
// ============================================================

async function loadSettings() {
  try {
    const { settings } = await api('/admin/settings');
    // Handle both boolean and string values
    const isOpen = settings.membership_open === true || settings.membership_open === 'true';
    $('setting-membership-open').checked = isOpen;
    $('setting-current-year').value = settings.current_year || '2024-2025';
    // Reset dirty state after loading
    elements.saveSettingsBtn.disabled = true;
  } catch (err) {
    console.error('Settings error:', err);
  }
}

async function saveSettings() {
  try {
    await api('/admin/settings', {
      method: 'PUT',
      body: JSON.stringify({
        membership_open: $('setting-membership-open').checked ? 'true' : 'false',
        current_year: $('setting-current-year').value
      })
    });
    toastSuccess('Paramètres enregistrés');
    elements.saveSettingsBtn.disabled = true;
  } catch (err) {
    toastError(err.message);
  }
}

function markSettingsDirty() {
  elements.saveSettingsBtn.disabled = false;
}

// ============================================================
// INIT
// ============================================================

async function init() {
  elements.authBtn.addEventListener('click', handleAuth);
  elements.tokenInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleAuth();
  });
  elements.exportBtn.addEventListener('click', handleExport);
  elements.refreshBtn.addEventListener('click', () => {
    loadData();
    toastSuccess('Données actualisées');
  });
  elements.approveAllBtn.addEventListener('click', approveAll);
  elements.memberForm.addEventListener('submit', handleMemberSubmit);
  elements.filterSearch.addEventListener('input', debounce(() => renderMembers(membersData), 300));
  elements.filterStatus.addEventListener('change', () => renderMembers(membersData));
  elements.filterTrack.addEventListener('change', () => renderMembers(membersData));
  elements.saveSettingsBtn.addEventListener('click', saveSettings);
  elements.importFile.addEventListener('change', handleImportFileChange);
  elements.importBtn.addEventListener('click', handleImport);

  $('setting-membership-open').addEventListener('change', markSettingsDirty);
  $('setting-current-year').addEventListener('input', markSettingsDirty);

  // Modal close on backdrop
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.classList.add('hidden');
    });
  });

  // Auto-login if token exists
  if (adminToken) {
    try {
      await loadData();
      await loadSettings();
      showAdmin();
    } catch {
      showAuth();
      localStorage.removeItem('join_admin_token');
      adminToken = '';
    }
  } else {
    showAuth();
  }
}

init();
</script>

<style>
/* Members toolbar and filters */
.members-toolbar {
  margin-bottom: var(--space-4);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.filters-row {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  align-items: center;
}

.filter-search {
  flex: 1;
  min-width: 200px;
  max-width: 400px;
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--border-default);
  border-radius: var(--radius);
  font: inherit;
  font-size: var(--text-sm);
  background-color: var(--color-surface);
  color: var(--color-text);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.filter-search:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(0, 27, 165, 0.2);
}

.filter-search::placeholder {
  color: var(--color-text-muted);
}

/* Bulk actions bar */
.bulk-actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3);
  background: rgba(0, 27, 165, 0.1);
  border: 1px solid var(--color-primary);
  border-radius: var(--radius);
  flex-wrap: wrap;
}

.bulk-actions span {
  font-weight: 600;
  color: var(--color-primary);
  margin-right: var(--space-2);
}

/* Wide table for more columns */
.table-container {
  overflow-x: auto;
}

.members-table-wide {
  min-width: 1000px;
}

.members-table-wide th,
.members-table-wide td {
  white-space: nowrap;
}

.members-table-wide td:nth-child(2) {
  white-space: normal;
  max-width: 200px;
}

/* Contact cell */
.contact-cell {
  font-size: var(--text-xs);
  line-height: 1.4;
}

/* Action buttons in table */
.action-buttons {
  display: flex;
  gap: var(--space-1);
}

/* Selected row */
tr.selected td {
  background: rgba(0, 27, 165, 0.1) !important;
}

/* Text muted helper */
.text-muted {
  color: var(--color-text-muted);
}

small.text-muted {
  font-size: var(--text-xs);
}

/* Sortable headers */
.sortable {
  cursor: pointer;
  user-select: none;
  transition: background-color var(--transition-fast);
}

.sortable:hover {
  background-color: rgba(0, 27, 165, 0.1);
}

@media (max-width: 768px) {
  .filters-row {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-search {
    max-width: none;
  }

  .bulk-actions {
    flex-direction: column;
    align-items: flex-start;
  }
}
</style>
